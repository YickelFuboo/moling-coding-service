from sqlalchemy import Column, String, Boolean, DateTime, Integer, Text, JSON
from sqlalchemy.orm import relationship
from datetime import datetime


class DocumentCatalog():
    """文档目录模型"""
    __tablename__ = "document_catalogs"

    id = Column(String, primary_key=True, index=True, comment="ID")    
    repo_id = Column(String, nullable=False, index=True, comment="代码仓对象库ID")
    wiki_document_id = Column(String, nullable=False, index=True, comment="文档ID")

    name = Column(String(200), nullable=False, comment="目录名称")
    url = Column(String(500), nullable=False, comment="目录URL")
    description = Column(Text, nullable=True, comment="目录描述")
    parent_id = Column(String(36), nullable=True, comment="目录父级ID")
    order = Column(Integer, default=0, comment="当前目录排序")

    # 状态信息
    is_completed = Column(Boolean, default=False, comment="是否处理完成")
    prompt = Column(Text, nullable=True, comment="提示词")
    is_deleted = Column(Boolean, default=False, comment="是否删除")
    deleted_time = Column(DateTime, nullable=True, comment="删除时间")

    # 时间戳
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False, comment="创建时间")
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False, comment="更新时间")

    # 关系
    file_items = relationship("DocumentFileItem", back_populates="catalog", cascade="all, delete-orphan")

    def to_dict(self):
        """转换为字典"""
        return {
            "id": self.id,
            "repo_id": self.repo_id,
            "wiki_document_id": self.wiki_document_id,
            "name": self.name,
            "url": self.url,
            "description": self.description,
            "parent_id": self.parent_id,
            "order": self.order,
            "is_completed": self.is_completed,
            "prompt": self.prompt,
            "is_deleted": self.is_deleted,
            "deleted_time": self.deleted_time.isoformat() if self.deleted_time else None,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None
        }


class DocumentFileItem():
    """文档文件项模型"""
    __tablename__ = "document_file_items"

    id = Column(String, primary_key=True, index=True, comment="ID")
    document_catalog_id = Column(String(36), nullable=False, comment="绑定的目录ID")
    
    title = Column(String(200), nullable=False, comment="标题")
    description = Column(Text, nullable=True, comment="描述")
    content = Column(Text, nullable=True, comment="文档实际内容")
    size = Column(Integer, default=0, comment="文档大小")
    source_file_items = Column(JSON, default=dict, comment="相关源文件源数据，DocumentFileItemSource")
    metadata = Column(JSON, default=dict, comment="源数据")
    extra = Column(JSON, default=dict, comment="扩展数据")
    
    # 时间戳
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False, comment="创建时间")
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False, comment="更新时间")

    # 关系
    catalog = relationship("DocumentCatalog", back_populates="file_items")
    sources = relationship("DocumentFileItemSource", back_populates="file_item", cascade="all, delete-orphan")

    def to_dict(self):
        """转换为字典"""
        return {
            "id": self.id,
            "document_catalog_id": self.document_catalog_id,
            "title": self.title,
            "description": self.description,
            "content": self.content,
            "size": self.size,
            "source_file_items": self.source_file_items,
            "metadata": self.metadata,
            "extra": self.extra,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None
        }


class DocumentFileItemSource():
    """文档文件项源模型"""
    __tablename__ = "document_file_item_sources"

    id = Column(String, primary_key=True, index=True, comment="ID")
    file_item_id = Column(String(36), nullable=False, comment="文件项ID")
    file_path = Column(String(500), nullable=False, comment="文件路径")
    file_name = Column(String(200), nullable=False, comment="文件名称")
    
    # 时间戳
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False, comment="创建时间")
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False, comment="更新时间")

    # 关系
    file_item = relationship("DocumentFileItem", back_populates="sources")

    def to_dict(self):
        """转换为字典"""
        return {
            "id": self.id,
            "file_item_id": self.file_item_id,
            "file_path": self.file_path,
            "file_name": self.file_name,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None
        } 